import*as f from"https://ibelem.github.io/webnn-developer-preview/assets/dist_transformers/1.22.0-dev.20250325/transformers.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function r(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerPolicy&&(n.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?n.credentials="include":t.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function a(t){if(t.ep)return;t.ep=!0;const n=r(t);fetch(t.href,n)}})();const y="https://images.pexels.com/photos/5965592/pexels-photo-5965592.jpeg?auto=compress&cs=tinysrgb&w=1024",p=document.getElementById("status"),E=document.getElementById("device"),v=document.getElementById("upload"),c=document.getElementById("container"),N=document.getElementById("example");let g=null;const D=async()=>{if(g)return g;const o="huggingface.co",e="hf-mirror.com",r="/webml/models-moved/resolve/main/01.onnx",a=async s=>{const l=new AbortController,i=setTimeout(()=>l.abort(),2e3);try{const d=await fetch(`https://${s}${r}`,{method:"HEAD",signal:l.signal,cache:"no-store"});return clearTimeout(i),d.ok}catch(d){return console.log(`Error reaching ${s}:`,d),clearTimeout(i),!1}};return await a(o)?(g=o,o):await a(e)?(console.log(`Hugging Face main domain unreachable. Switching to mirror: ${e}`),g=e,e):(g=o,o)};p.textContent="Loading model...";function I(o,e){const r="webnn-gpu",a="fp16",t=["webnn-gpu","webnn-cpu","webnn-npu"],n=["fp16","fp32","int8"],s=(o||r).toLowerCase(),l=e&&n.includes(e.toLowerCase())?e.toLowerCase():t.includes(s)?a:"fp16",b=t.includes(s)?{freeDimensionOverrides:{height:1024,width:1024},logSeverityLevel:0,model_type:"custom"}:{logSeverityLevel:0,model_type:"custom"};return{device:s,dtype:l,sessionOptions:b}}const h=new URLSearchParams(window.location.search);let{device:m,dtype:R,sessionOptions:_}=I(h.get("device"),h.get("dtype")),u="WebNN GPU";switch(m){case"webgpu":u="WebGPU";break;case"webnn-gpu":u="WebNN GPU";break;case"webnn-cpu":u="WebNN CPU";break;case"webnn-npu":u="WebNN NPU";break;default:u="WebNN GPU"}E.textContent=u;["webgpu","webnn-gpu","webnn-cpu","webnn-npu"].includes(m)||(p.textContent=`Unsupported device ${m}. Falling back to WebNN GPU.`,m="webnn-gpu");let A=await D();A!=="huggingface.co"&&(console.log(`Using alternative Hugging Face mirror: ${A}`),f.env.remoteHost=`https://${A}`);const U=await f.AutoModel.from_pretrained("briaai/RMBG-1.4",{device:m,dtype:R,session_options:_}),x=await f.AutoProcessor.from_pretrained("briaai/RMBG-1.4",{config:{do_normalize:!0,do_pad:!1,do_rescale:!0,do_resize:!0,image_mean:[.5,.5,.5],feature_extractor_type:"ImageFeatureExtractor",image_std:[1,1,1],resample:2,rescale_factor:.00392156862745098,size:{width:1024,height:1024}}});p.textContent="Ready";N.addEventListener("click",o=>{o.preventDefault(),w(y)});v.addEventListener("change",function(o){const e=o.target.files[0];if(!e)return;const r=new FileReader;r.onload=a=>w(a.target.result),r.readAsDataURL(e)});async function w(o){const e=await f.RawImage.fromURL(o);c.innerHTML="",c.style.backgroundImage=`url(${o})`;const r=e.width/e.height,[a,t]=r>720/480?[720,720/r]:[480*r,480];c.style.width=`${a}px`,c.style.height=`${t}px`,p.textContent="Analysing...";const{pixel_values:n}=await x(e),{output:s}=await U({input:n}),l=await RawImage.fromTensor(s[0].mul(255).to("uint8")).resize(e.width,e.height);e.putAlpha(l);const i=document.createElement("canvas");i.width=e.width,i.height=e.height,i.getContext("2d").drawImage(e.toCanvas(),0,0),c.append(i),c.style.removeProperty("background-image"),c.style.background='url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQBAMAAADt3eJSAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAGUExURb+/v////5nD/3QAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAUSURBVBjTYwABQSCglEENMxgYGAAynwRB8BEAgQAAAABJRU5ErkJggg==")',p.textContent="Done!"}
